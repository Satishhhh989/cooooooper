<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coopergen - AI Question Paper Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            color: #e2e8f0; /* text-slate-200 */
        }
        
        /* Glassmorphism card style */
        .glass-card {
            background: rgba(30, 41, 59, 0.3); /* bg-slate-800/30 */
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem; /* rounded-2xl */
        }

        /* Glassmorphism input style */
        .glass-input {
            background: rgba(15, 23, 42, 0.5); /* bg-slate-900/50 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0; /* text-slate-200 */
        }
        .glass-input::placeholder {
            color: #94a3b8; /* text-slate-400 */
        }
        
        /* Animated Aurora Background */
        .aurora-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -10;
        }
        .aurora-blob {
            position: absolute;
            filter: blur(100px);
            opacity: 0.3;
            border-radius: 50%;
        }
        .blob-1 {
            background-color: #3b82f6; /* blue-500 */
            width: 400px;
            height: 400px;
            top: 10%;
            left: 10%;
            animation: moveBlob1 20s infinite alternate;
        }
        .blob-2 {
            background-color: #8b5cf6; /* violet-500 */
            width: 500px;
            height: 500px;
            top: 50%;
            left: 60%;
            animation: moveBlob2 25s infinite alternate;
        }
        @keyframes moveBlob1 {
            from { transform: translate(-50px, -50px) rotate(0deg); }
            to { transform: translate(100px, 150px) rotate(360deg); }
        }
        @keyframes moveBlob2 {
            from { transform: translate(50px, 50px) rotate(0deg); }
            to { transform: translate(-100px, -150px) rotate(-360deg); }
        }

        /* Video Background */
        #video-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -5;
            transform: translate(-50%, -50%);
            transition: opacity 0.5s ease;
        }

        /* View transitions */
        .view {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block;
            opacity: 1;
        }

        /* Custom toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155; /* bg-slate-700 */
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6; /* bg-blue-600 */
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }

        /* Custom scrollbar for "My Papers" */
        .papers-list::-webkit-scrollbar {
            width: 6px;
        }
        .papers-list::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5); /* bg-slate-900/50 */
            border-radius: 10px;
        }
        .papers-list::-webkit-scrollbar-thumb {
            background: #3b82f6; /* bg-blue-600 */
            border-radius: 10px;
        }
        .papers-list::-webkit-scrollbar-thumb:hover {
            background: #2563eb; /* bg-blue-700 */
        }

    </style>
</head>

<body class="bg-slate-900 h-full">

    <!-- Backgrounds -->
    <video autoplay muted loop id="video-bg" class="hidden">
        <source src="vid.mp4" type="video/mp4">
    </video>
    <div class="aurora-bg" id="aurora-bg">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
    </div>

    <!-- Main Container -->
    <div class="relative min-h-full">

        <!-- ===== LANDING PAGE (VIEW 0) ===== -->
        <div id="landing-page" class="view active flex flex-col items-center justify-center text-center h-screen p-4">
            <!-- FIXED TYPO: "classs" is now "class" -->
            <div class="relative z-10">
                <h1 class="text-5xl sm:text-7xl md:text-8xl font-bold text-white mb-6">
                    Coopergen
                </h1>
                <p class="text-lg sm:text-xl text-slate-300 mb-10 max-w-2xl">
                    The AI Question Paper Generator. Create flawless, secure question papers in seconds, not hours.
                </p>
                <button id="get-started-btn" class="bg-white text-slate-900 font-semibold py-3 px-8 rounded-full text-lg hover:bg-slate-200 transition-all shadow-lg">
                    Lessgoo
                </button>
            </div>
        </div>

        <!-- ===== LOGIN PAGE (VIEW 1) ===== -->
        <div id="login-page" class="view flex flex-col items-center justify-center h-screen p-4">
            <div class="w-full max-w-md">
                <div class="glass-card p-8 text-center">
                    <h2 class="text-3xl font-semibold text-white mb-6">Welcome Back</h2>
                    <p class="text-slate-300 mb-8">Sign in to continue to your dashboard.</p>
                    <button id="login-btn" class="w-full bg-white text-slate-900 font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-3 hover:bg-slate-200 transition">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691L21.303 24l-5.657 5.657C11.353 34.046 6.053 29.268 6.053 24c0-2.225.55-4.328 1.51-6.142L6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.641-3.27-11.283-7.94l-5.736 5.699C9.043 40.619 15.935 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c.792 2.23.173 4.767-1.303 6.586l6.19 5.238C42.021 36.326 44 30.606 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        Sign in with Google
                    </button>
                    <button id="back-to-landing-btn" class="w-full mt-4 text-slate-400 hover:text-white transition">
                        &larr; Back
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== NAME MODAL (VIEW 2) ===== -->
        <div id="name-modal" class="view fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);">
            <div class="glass-card w-full max-w-md p-8">
                <h2 class="text-3xl font-semibold text-white mb-4">One Last Step</h2>
                <p class="text-slate-300 mb-6">Please tell us your name. This will be used to personalize your account.</p>
                <form id="name-form">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-slate-300 mb-2">Full Name</label>
                        <input type="text" id="name" name="name" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Satish Kumar" required>
                    </div>
                    <button type="submit" id="save-name-btn" class="w-full bg-blue-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-blue-700 transition">
                        Save and Continue
                    </button>
                </form>
            </div>
        </div>

        <!-- ===== PROFILE MODAL (VIEW 3) ===== -->
        <div id="profile-modal" class="view fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);">
            <div class="glass-card w-full max-w-md p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-semibold text-white">My Profile</h2>
                    <button id="close-profile-btn" class="text-slate-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="profile-form">
                    <div class="mb-4">
                        <label for="profile-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <input type="email" id="profile-email" class="w-full px-4 py-3 rounded-lg glass-input bg-slate-800/50 cursor-not-allowed" disabled>
                    </div>
                    <div class="mb-6">
                        <label for="profile-name" class="block text-sm font-medium text-slate-300 mb-2">Full Name</label>
                        <input type="text" id="profile-name" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Satish Kumar" required>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="cancel-profile-btn" class="bg-slate-700 text-white font-medium py-2 px-6 rounded-lg hover:bg-slate-600 transition">
                            Cancel
                        </button>
                        <button type="submit" id="save-profile-btn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ===== MY PAPERS DASHBOARD (VIEW 4) ===== -->
        <div id="papers-page" class="view min-h-screen">
            <!-- Header (Re-used) -->
            <header class="sticky top-0 z-40 glass-card mx-4 sm:mx-8 mt-4">
                <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold text-white cursor-pointer" id="header-title-papers">Coopergen</h1>
                        <button id="back-to-app-btn" class="text-slate-300 hover:text-white transition">&larr; Back to Generator</button>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="user-greeting-papers" class="text-slate-300 hidden sm:block">Hi, User</span>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="container mx-auto px-4 sm:px-6">
                <!-- FIXED: Added padding here to fix "empty at top" -->
                <div class="pt-4 sm:pt-8 pb-12">
                    <h2 class="text-3xl font-semibold text-white mb-6">My Saved Papers</h2>
                    <div id="papers-list-container" class="papers-list glass-card p-6 min-h-[400px] max-h-[70vh] overflow-y-auto">
                        <!-- Loading state -->
                        <div id="papers-loading" class="text-center text-slate-400 py-20">
                            <p>Loading your saved papers...</p>
                        </div>
                        <!-- Empty state -->
                        <div id="papers-empty" class="text-center text-slate-400 py-20 hidden">
                            <h3 class="text-xl font-medium mb-2">No papers found</h3>
                            <p>Generate a new paper and click "Save" to see it here.</p>
                        </div>
                        <!-- Papers will be injected here -->
                    </div>
                </div>
            </main>
        </div>


        <!-- ===== MAIN APP PAGE (VIEW 5) ===== -->
        <div id="app-page" class="view min-h-screen">
            <!-- Header -->
            <header class="sticky top-0 z-40 glass-card mx-4 sm:mx-8 mt-4">
                <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                    <div class="flex items-center gap-6">
                        <h1 class="text-2xl font-bold text-white cursor-pointer" id="header-title-app">Coopergen</h1>
                        <button id="my-papers-btn" class="text-slate-300 hover:text-white transition hidden sm:block">My Papers</button>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="user-greeting" class="text-slate-300 hidden sm:block">Hi, User</span>
                        <button id="profile-btn" class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-semibold text-white hover:bg-blue-700 transition" title="My Profile">
                            <span id="user-initial">U</span>
                        </button>
                        <button id="logout-btn" class="text-slate-400 hover:text-white transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content Grid -->
            <main class="container mx-auto px-4 sm:px-6">
                <!-- FIXED: Added padding here to fix "empty at top" -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-4 sm:pt-8 pb-12">
                
                    <!-- Left Side: Form -->
                    <form id="paper-form" class="glass-card p-6 sm:p-8">
                        <h2 class="text-3xl font-semibold text-white mb-6">Paper Blueprint</h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Column 1 -->
                            <div>
                                <div class="mb-4">
                                    <label for="board" class="block text-sm font-medium text-slate-300 mb-2">Board</label>
                                    <input type="text" id="board" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., CBSE, ICSE" required>
                                </div>
                                <div class="mb-4">
                                    <label for="subject" class="block text-sm font-medium text-slate-300 mb-2">Subject</label>
                                    <input type="text" id="subject" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Physics, History" required>
                                </div>
                                <div class="mb-4">
                                    <label for="difficulty" class="block text-sm font-medium text-slate-300 mb-2">Difficulty</label>
                                    <select id="difficulty" class="w-full px-4 py-3 rounded-lg glass-input appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label for="time" class="block text-sm font-medium text-slate-300 mb-2">Time (minutes)</label>
                                    <input type="number" id="time" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" value="120">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div>
                                <div class="mb-4">
                                    <label for="grade" class="block text-sm font-medium text-slate-300 mb-2">Class / Grade</label>
                                    <input type="text" id="grade" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 10th, 12th" required>
                                </div>
                                <div class="mb-4">
                                    <label for="topic" class="block text-sm font-medium text-slate-300 mb-2">Topic(s)</label>
                                    <input type="text" id="topic" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Magnetism, The Mughal Empire" required>
                                </div>
                                <div class="mb-4">
                                    <label for="language" class="block text-sm font-medium text-slate-300 mb-2">Language</label>
                                    <select id="language" class="w-full px-4 py-3 rounded-lg glass-input appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="English" selected>English</option>
                                        <option value="Hindi">Hindi</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label for="marks" class="block text-sm font-medium text-slate-300 mb-2">Total Marks</label>
                                    <input type="number" id="marks" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" value="70">
                                </div>
                            </div>
                        </div>

                        <!-- Question Counts -->
                        <div class="mt-6 border-t border-white/10 pt-6">
                            <h3 class="text-xl font-semibold text-white mb-4">Question Types</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label for="mcq" class="block text-sm font-medium text-slate-300 mb-2">MCQs</label>
                                    <input type="number" id="mcq" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" value="10">
                                </div>
                                <div>
                                    <label for="short" class="block text-sm font-medium text-slate-300 mb-2">Short</label>
                                    <input type="number" id="short" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" value="5">
                                </div>
                                <div>
                                    <label for="long" class="block text-sm font-medium text-slate-300 mb-2">Long</label>
                                    <input type="number" id="long" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" value="3">
                                </div>
                                <div>
                                    <label for="numerical" class="block text-sm font-medium text-slate-300 mb-2">Numerical</label>
                                    <input type="number" id="numerical" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Extra Instructions -->
                        <div class="mt-6 border-t border-white/10 pt-6">
                            <label for="extra" class="block text-sm font-medium text-slate-300 mb-2">Extra Instructions</label>
                            <textarea id="extra" rows="3" class="w-full px-4 py-3 rounded-lg glass-input focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'All questions are compulsory', 'Focus on practical examples'"></textarea>
                        </div>

                        <!-- Generate Button -->
                        <div class="mt-8">
                            <button type="submit" id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <svg id="generate-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                                </svg>
                                <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span id="generate-btn-text">Generate Paper</span>
                            </button>
                        </div>
                    </form>

                    <!-- Right Side: Preview -->
                    <div class="glass-card p-6 sm:p-8">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                            <h2 class="text-3xl font-semibold text-white mb-4 sm:mb-0">Live Preview</h2>
                            <div class="flex items-center gap-4">
                                <span class="text-slate-300 text-sm">Include Answers</span>
                                <label class="switch">
                                    <input type="checkbox" id="include-answers-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div id="preview-container" class="bg-slate-900/50 rounded-lg p-6 min-h-[400px] max-h-[100vh] overflow-y-auto" style="font-family: 'Times New Roman', Times, serif;">
                            <div id="preview-placeholder" class="text-center text-slate-400 pt-20">
                                <p>Your generated question paper will appear here...</p>
                            </div>
                            <div id="preview-content" class="hidden">
                                <!-- Paper will be rendered here -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div id="action-buttons" class="mt-6 flex flex-col sm:flex-row gap-4 hidden">
                            <button id="save-paper-btn" class="flex-1 bg-green-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-green-700 transition">
                                Save Paper
                            </button>
                            <button id="download-pdf-btn" class="flex-1 bg-red-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-red-700 transition">
                                Download PDF
                            </button>
                            <button id="download-json-btn" class="flex-1 bg-slate-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-slate-700 transition">
                                Download JSON
                            </button>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- Global Error Toast -->
        <div id="error-toast" class="fixed bottom-5 right-5 z-50 glass-card p-4 border-red-500 border-l-4 hidden">
            <p id="error-message" class="text-red-300">An error occurred.</p>
        </div>
        
        <!-- Global Success Toast -->
        <div id="success-toast" class="fixed bottom-5 right-5 z-50 glass-card p-4 border-green-500 border-l-4 hidden">
            <p id="success-message" class="text-green-300">Success!</p>
        </div>

    </div>


    <!-- ===== JAVASCRIPT ===== -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, getDocs, deleteDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDCkWwVm0LuqxfHczruse9gh8pGGyI4nvg",
            authDomain: "coopergen-5332f.firebaseapp.com",
            projectId: "coopergen-5332f",
            storageBucket: "coopergen-5332f.firebasestorage.app",
            messagingSenderId: "432850916875",
            appId: "1:432850916875:web:c5dc6709400082cab3190e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Global State ---
        let currentUser = null; // Store user object
        let currentUserId = null; // Store user ID
        let currentPaperData = null; // Store generated paper JSON
        let currentPaperId = null; // Store ID of the paper being previewed (if loaded from history)

        // --- DOM Elements ---
        const views = {
            landing: document.getElementById('landing-page'),
            login: document.getElementById('login-page'),
            nameModal: document.getElementById('name-modal'),
            profileModal: document.getElementById('profile-modal'),
            papersPage: document.getElementById('papers-page'),
            app: document.getElementById('app-page')
        };
        const videoBg = document.getElementById('video-bg');
        const auroraBg = document.getElementById('aurora-bg');
        
        const loginBtn = document.getElementById('login-btn');
        const getStartedBtn = document.getElementById('get-started-btn');
        const backToLandingBtn = document.getElementById('back-to-landing-btn');
        
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name');
        
        const profileBtn = document.getElementById('profile-btn');
        const profileForm = document.getElementById('profile-form');
        const profileEmailInput = document.getElementById('profile-email');
        const profileNameInput = document.getElementById('profile-name');
        const closeProfileBtn = document.getElementById('close-profile-btn');
        const cancelProfileBtn = document.getElementById('cancel-profile-btn');
        
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');
        const userGreetingPapers = document.getElementById('user-greeting-papers');
        const userInitial = document.getElementById('user-initial');
        
        const paperForm = document.getElementById('paper-form');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateIcon = document.getElementById('generate-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        const previewContainer = document.getElementById('preview-container');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const previewContent = document.getElementById('preview-content');
        const actionButtons = document.getElementById('action-buttons');
        const savePaperBtn = document.getElementById('save-paper-btn');
        
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadJsonBtn = document.getElementById('download-json-btn');
        const includeAnswersToggle = document.getElementById('include-answers-toggle');

        const errorToast = document.getElementById('error-toast');
        const errorMessage = document.getElementById('error-message');
        const successToast = document.getElementById('success-toast');
        const successMessage = document.getElementById('success-message');
        
        // "My Papers" Dashboard Elements
        const myPapersBtn = document.getElementById('my-papers-btn');
        const backToAppBtn = document.getElementById('back-to-app-btn');
        const papersListContainer = document.getElementById('papers-list-container');
        const papersLoading = document.getElementById('papers-loading');
        const papersEmpty = document.getElementById('papers-empty');
        const headerTitleApp = document.getElementById('header-title-app');
        const headerTitlePapers = document.getElementById('header-title-papers');

        // --- Toast Notifications ---
        function showError(message) {
            errorMessage.textContent = message;
            errorToast.classList.remove('hidden');
            setTimeout(() => {
                errorToast.classList.add('hidden');
            }, 3000);
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }

        // --- View & Navigation ---
        function showView(viewName) {
            // Deactivate all views first
            Object.values(views).forEach(view => {
                view.classList.remove('active');
            });
            
            // Activate the target view
            if (views[viewName]) {
                views[viewName].classList.add('active');
            }
            
            // FIXED: Use a small delay (50ms) to ensure the DOM is ready
            // for the scroll command. This fixes the "stuck" bug.
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 50); // 50ms delay is more reliable

            // Video/Aurora logic
            if (viewName === 'landing' || viewName === 'login') {
                videoBg.style.opacity = '1';
                if (!videoBg.paused) videoBg.play();
                auroraBg.style.display = 'none';
            } else {
                videoBg.style.opacity = '0';
                videoBg.pause();
                auroraBg.style.display = 'block';
            }
        }

        // --- Video Background Fallback ---
        videoBg.onerror = () => {
            console.warn("Video 'vid.mp4' not found or failed to load. Using aurora background.");
            videoBg.classList.add('hidden');
            auroraBg.style.display = 'block';
        };
        // Check if video can play, if not, use fallback
        if (videoBg.HAVE_NOTHING) {
             videoBg.onerror();
        } else {
            videoBg.classList.remove('hidden');
        }

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                currentUserId = user.uid;
                
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        // User exists, go to app
                        const userData = userDoc.data();
                        updateUserUI(userData.name);
                        showView('app');
                    } else {
                        // New user, ask for name
                        showView('nameModal');
                    }
                } catch (error) {
                    console.error("Firestore Error on auth change:", error);
                    showError("Error: " + error.message);
                    if (error.code === 'permission-denied') {
                        showError("Error: Permission denied. Check Firestore rules.");
                    } else if (error.message.includes("offline")) {
                        showError("Connection failed. Please disable ad blockers and refresh.");
                    }
                }
            } else {
                // User is signed out
                currentUser = null;
                currentUserId = null;
                updateUserUI(null);
                showView('landing');
            }
        });

        function updateUserUI(name) {
            if (name) {
                const greeting = `Hi, ${name.split(' ')[0]}`;
                userGreeting.textContent = greeting;
                userGreetingPapers.textContent = greeting;
                userInitial.textContent = name.charAt(0).toUpperCase();
                userGreeting.classList.remove('hidden');
                userGreetingPapers.classList.remove('hidden');
            } else {
                userGreeting.classList.add('hidden');
                userGreetingPapers.classList.add('hidden');
            }
        }

        loginBtn.onclick = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showError("Sign-in failed: " + error.message);
            }
        };

        logoutBtn.onclick = async () => {
            await signOut(auth);
            showView('landing');
        };

        getStartedBtn.onclick = () => showView('login');
        backToLandingBtn.onclick = () => showView('landing');

        // --- User Onboarding (Name Form) ---
        nameForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            if (name && currentUser) {
                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await setDoc(userDocRef, {
                        name: name,
                        email: currentUser.email,
                        createdAt: serverTimestamp()
                    });
                    
                    updateUserUI(name);
                    showView('app');
                } catch (error) {
                    console.error("Error saving name:", error);
                    showError("Failed to save name: " + error.message);
                }
            }
        };

        // --- Profile Modal ---
        profileBtn.onclick = async () => {
            if (!currentUser) return;
            try {
                const userDoc = await getDoc(doc(db, "users", currentUserId));
                if (userDoc.exists()) {
                    profileEmailInput.value = currentUser.email;
                    profileNameInput.value = userDoc.data().name;
                    showView('profileModal');
                }
            } catch (error) {
                showError("Failed to load profile.");
            }
        };

        function closeProfileModal() {
            showView('app');
        }
        closeProfileBtn.onclick = closeProfileModal;
        cancelProfileBtn.onclick = closeProfileModal;
        
        profileForm.onsubmit = async (e) => {
            e.preventDefault();
            const newName = profileNameInput.value.trim();
            if (!newName || !currentUserId) return;
            
            try {
                const userDocRef = doc(db, "users", currentUserId);
                await updateDoc(userDocRef, { name: newName });
                
                updateUserUI(newName);
                showSuccess("Profile updated successfully!");
                closeProfileModal();
            } catch (error) {
                console.error("Error updating profile:", error);
                showError("Failed to update profile: " + error.message);
            }
        };

        // --- "My Papers" Dashboard ---
        myPapersBtn.onclick = () => {
            loadSavedPapers();
            showView('papersPage');
        };
        
        headerTitleApp.onclick = () => {
             // Reset preview when going back
            resetPreview();
            showView('app');
        }
        
        backToAppBtn.onclick = () => {
            // Reset preview when going back
            resetPreview();
            showView('app');
        };
        headerTitlePapers.onclick = () => showView('landing');


        async function loadSavedPapers() {
            if (!currentUserId) return;
            
            papersLoading.classList.remove('hidden');
            papersEmpty.classList.add('hidden');
            papersListContainer.innerHTML = ''; // Clear old list
            papersListContainer.appendChild(papersLoading); // Add loading spinner back
            
            try {
                const papersCollectionRef = collection(db, "users", currentUserId, "papers");
                const querySnapshot = await getDocs(papersCollectionRef);
                
                papersLoading.classList.add('hidden');

                if (querySnapshot.empty) {
                    papersListContainer.appendChild(papersEmpty);
                    papersEmpty.classList.remove('hidden');
                    return;
                }
                
                let papersHtml = '';
                querySnapshot.docs.forEach((doc) => {
                    const paper = doc.data();
                    const metadata = paper.paperData?.metadata || {};
                    const title = metadata.subject || 'Untitled Paper';
                    const topic = metadata.topic || 'No topic';
                    const date = paper.createdAt?.toDate ? paper.createdAt.toDate().toLocaleDateString() : 'Unknown date';

                    papersHtml += `
                        <div class="glass-card p-4 mb-4 flex justify-between items-center transition-all hover:border-white/20">
                            <div>
                                <h4 class="text-lg font-semibold text-white">${title}</h4>
                                <p class="text-sm text-slate-400">${topic} - ${metadata.class || ''}</p>
                                <p class="text-xs text-slate-500">Saved on: ${date}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="load-paper-btn bg-blue-600 text-white text-sm py-2 px-4 rounded-lg hover:bg-blue-700" data-id="${doc.id}">Load</button>
                                <button class="delete-paper-btn bg-red-600 text-white text-sm py-2 px-4 rounded-lg hover:bg-red-700" data-id="${doc.id}">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                papersListContainer.innerHTML = papersHtml;
                
                // Add event listeners for new buttons
                document.querySelectorAll('.load-paper-btn').forEach(btn => {
                    btn.onclick = (e) => loadPaper(e.target.dataset.id);
                });
                document.querySelectorAll('.delete-paper-btn').forEach(btn => {
                    btn.onclick = (e) => deletePaper(e.target.dataset.id);
                });
                
            } catch (error) {
                console.error("Error loading saved papers:", error);
                papersLoading.classList.add('hidden');
                papersListContainer.innerHTML = ''; // Clear
                papersListContainer.appendChild(papersEmpty);
                papersEmpty.classList.remove('hidden');
                showError("Failed to load saved papers.");
            }
        }
        
        async function loadPaper(paperId) {
            if (!currentUserId || !paperId) return;
            
            try {
                const paperDocRef = doc(db, "users", currentUserId, "papers", paperId);
                const paperDoc = await getDoc(paperDocRef);
                
                if (paperDoc.exists()) {
                    const paperData = paperDoc.data().paperData;
                    currentPaperData = paperData;
                    currentPaperId = paperId; // Set current paper ID
                    
                    renderPaper(paperData);
                    actionButtons.classList.remove('hidden');
                    savePaperBtn.textContent = 'Saved'; // Show as saved
                    savePaperBtn.disabled = true;
                    savePaperBtn.classList.add('bg-green-800', 'cursor-not-allowed');
                    savePaperBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    
                    showView('app'); // Switch back to app view
                } else {
                    showError("Paper not found.");
                }
            } catch (error) {
                console.error("Error loading paper:", error);
                showError("Failed to load paper.");
            }
        }

        async function deletePaper(paperId) {
            if (!currentUserId || !paperId) return;
            
            // Simple confirm, replace with modal later if needed
            if (!confirm("Are you sure you want to delete this paper? This cannot be undone.")) {
                return;
            }
            
            try {
                const paperDocRef = doc(db, "users", currentUserId, "papers", paperId);
                await deleteDoc(paperDocRef);
                
                showSuccess("Paper deleted successfully.");
                loadSavedPapers(); // Refresh the list
                
                // If the deleted paper is the one being previewed, reset preview
                if (currentPaperId === paperId) {
                    resetPreview();
                }
                
            } catch (error) {
                console.error("Error deleting paper:", error);
                showError("Failed to delete paper.");
            }
        }

        // --- Paper Generation ---
        paperForm.onsubmit = async (e) => {
            e.preventDefault();
            
            // Collect data from form
            const blueprint = {
                board: document.getElementById('board').value,
                grade: document.getElementById('grade').value,
                subject: document.getElementById('subject').value,
                topic: document.getElementById('topic').value,
                difficulty: document.getElementById('difficulty').value,
                language: document.getElementById('language').value,
                time: parseInt(document.getElementById('time').value),
                totalMarks: parseInt(document.getElementById('marks').value),
                questionCounts: {
                    mcq: parseInt(document.getElementById('mcq').value),
                    short: parseInt(document.getElementById('short').value),
                    long: parseInt(document.getElementById('long').value),
                    numerical: parseInt(document.getElementById('numerical').value),
                },
                extra: document.getElementById('extra').value
            };

            // Show loading state
            generateBtn.disabled = true;
            generateBtnText.textContent = 'Generating...';
            generateIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            // Reset previous paper
            resetPreview();

            try {
                // Call our own secure /api/generate endpoint
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ blueprint: blueprint }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Generation failed');
                }

                const data = await response.json();
                
                if (data.paper) {
                    currentPaperData = data.paper; // Store the JSON
                    renderPaper(currentPaperData);
                    actionButtons.classList.remove('hidden');
                } else {
                    throw new Error('Invalid response from server.');
                }

            } catch (error) {
                console.error('Error calling /api/generate:', error);
                showError(error.message);
                previewPlaceholder.textContent = `Error: ${error.message}`;
                previewPlaceholder.classList.remove('hidden');
            } finally {
                // Hide loading state
                generateBtn.disabled = false;
                generateBtnText.textContent = 'Generate Paper';
                generateIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        };

        function resetPreview() {
            currentPaperData = null;
            currentPaperId = null;
            previewContent.innerHTML = '';
            previewContent.classList.add('hidden');
            previewPlaceholder.textContent = 'Your generated question paper will appear here...';
            previewPlaceholder.classList.remove('hidden');
            actionButtons.classList.add('hidden');
            
            // Reset save button to its default state
            savePaperBtn.textContent = 'Save Paper';
            savePaperBtn.disabled = false;
            savePaperBtn.classList.remove('bg-green-800', 'cursor-not-allowed');
            savePaperBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        }

        // --- Save Paper ---
        savePaperBtn.onclick = async () => {
            if (!currentPaperData || !currentUserId) {
                showError("No paper to save.");
                return;
            }
            
            // Prevent re-saving if it was loaded
            if (currentPaperId) {
                showError("This paper is already saved.");
                return;
            }

            savePaperBtn.disabled = true;
            savePaperBtn.textContent = 'Saving...';
            
            try {
                const papersCollectionRef = collection(db, "users", currentUserId, "papers");
                const docRef = await addDoc(papersCollectionRef, {
                    paperData: currentPaperData,
                    createdAt: serverTimestamp()
                });
                
                currentPaperId = docRef.id; // Store new ID
                showSuccess("Paper saved successfully!");
                savePaperBtn.textContent = 'Saved';
                savePaperBtn.classList.add('bg-green-800', 'cursor-not-allowed');
                savePaperBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                
            } catch (error) {
                console.error("Error saving paper:", error);
                showError("Failed to save paper.");
                savePaperBtn.disabled = false;
                savePaperBtn.textContent = 'Save Paper';
            }
        };

        // --- Paper Rendering ---
        function renderPaper(data) {
            if (!data || !data.metadata) {
                previewPlaceholder.textContent = 'Generated paper has an invalid format.';
                previewPlaceholder.classList.remove('hidden');
                previewContent.classList.add('hidden');
                return;
            }
            
            const { metadata, sections } = data;
            const showAnswers = includeAnswersToggle.checked;
            
            let html = `
                <div class="text-center mb-6 text-slate-200">
                    <h3 class="text-xl font-bold">${metadata.board}</h3>
                    <h4 class="text-lg">${metadata.class} - ${metadata.subject}</h4>
                    <p class="text-sm">${metadata.topic}</p>
                    <div class="flex justify-between text-sm mt-2">
                        <span>Total Marks: ${metadata.totalMarks}</span>
                        <span>Time: ${metadata.time} minutes</span>
                    </div>
                </div>
            `;

            sections.forEach(section => {
                html += `
                    <div class="mb-6">
                        <h5 class="text-lg font-bold border-b border-slate-600 pb-2 mb-4 text-slate-100">${section.title} (Marks: ${section.marks})</h5>
                        <ol class="list-decimal list-outside ml-5 space-y-4 text-slate-300">
                `;
                
                section.questions.forEach(q => {
                    html += `<li class="mb-4 pl-2">`;
                    html += `<p class="font-semibold">${q.question} <span class="font-normal text-slate-400">(${q.marks} marks)</span></p>`;
                    
                    if (q.options) {
                        html += '<ul class="list-none mt-2 space-y-1">';
                        q.options.forEach(opt => {
                            html += `<li>( ${opt} )</li>`;
                        });
                        html += '</ul>';
                        if (showAnswers) {
                            html += `<p class="text-green-400 mt-2"><strong>Answer:</strong> ${q.answer}</p>`;
                        }
                    } else {
                        if (showAnswers) {
                            html += `<p class="text-green-400 mt-2"><strong>Answer:</strong> ${q.answer}</p>`;
                        }
                    }
                    html += `</li>`;
                });

                html += `</ol></div>`;
            });

            previewContent.innerHTML = html;
            previewPlaceholder.classList.add('hidden');
            previewContent.classList.remove('hidden');
        }

        // Re-render paper when "Include Answers" is toggled
        includeAnswersToggle.onchange = () => {
            if (currentPaperData) {
                renderPaper(currentPaperData);
            }
        };

        // --- Download Functions ---
        downloadJsonBtn.onclick = () => {
            if (!currentPaperData) return;
            const dataStr = JSON.stringify(currentPaperData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `${currentPaperData.metadata.subject || 'paper'}.json`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        downloadPdfBtn.onclick = () => {
            if (!currentPaperData) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { metadata, sections } = currentPaperData;
            const showAnswers = includeAnswersToggle.checked;
            let y = 20; // Y position for layout
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;

            function checkPageBreak(lines = 1) {
                if (y + (lines * 10) > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
            }
            
            // --- PDF Title ---
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(metadata.board || 'Board', 105, y, { align: 'center' });
            y += 8;
            checkPageBreak();
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.text(`${metadata.class || ''} - ${metadata.subject || ''}`, 105, y, { align: 'center' });
            y += 7;
            checkPageBreak();
            
            doc.setFontSize(14);
            doc.text(metadata.topic || '', 105, y, { align: 'center' });
            y += 10;
            
            // ***** THE FIX IS HERE *****
            // The typo was 'checkPageCheck()'. It is now 'checkPageBreak()'.
            checkPageBreak();

            doc.setFontSize(12);
            doc.text(`Total Marks: ${metadata.totalMarks}`, margin, y);
            doc.text(`Time: ${metadata.time} minutes`, 210 - margin, y, { align: 'right' });
            y += 15;
            checkPageBreak();
            
            // --- PDF Sections ---
            doc.setFont('helvetica', 'normal');
            
            sections.forEach(section => {
                checkPageBreak(2);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${section.title} (Marks: ${section.marks})`, margin, y);
                doc.setLineWidth(0.5);
                y += 2;
                doc.line(margin, y, 210 - margin, y); // Underline
                y += 10;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                
                section.questions.forEach(q => {
                    checkPageBreak(2);
                    // Split question text
                    const qText = `${q.q_num}. ${q.question} (${q.marks} marks)`;
                    const qLines = doc.splitTextToSize(qText, 170); // 170mm width
                    doc.text(qLines, margin, y);
                    y += qLines.length * 6; // Adjust y based on lines
                    
                    if (q.options) {
                        checkPageBreak(q.options.length);
                        q.options.forEach((opt, index) => {
                            doc.text(`(${String.fromCharCode(97 + index)}) ${opt}`, margin + 10, y);
                            y += 7;
                        });
                        if (showAnswers) {
                            checkPageBreak();
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(0, 100, 0); // Green
                            doc.text(`Answer: ${q.answer}`, margin + 10, y);
                            y += 7;
                            doc.setTextColor(0, 0, 0); // Reset color
                            doc.setFont('helvetica', 'normal');
                        }
                    } else {
                        if (showAnswers) {
                            checkPageBreak(2);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(0, 100, 0); // Green
                            const aLines = doc.splitTextToSize(`Answer: ${q.answer}`, 160);
                            doc.text(aLines, margin + 10, y);
                            y += aLines.length * 6;
                            doc.setTextColor(0, 0, 0); // Reset color
                            doc.setFont('helvetica', 'normal');
                        }
                    }
                    y += 5; // Extra space between questions
                });
            });

            doc.save(`${metadata.subject || 'paper'}.pdf`);
        };

    </script>
</body>
</html>
