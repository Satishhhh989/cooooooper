<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coopergen - AI Question Paper Generator</title>
    <!-- 1. Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. jsPDF CDN for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Improved view switching with fade transition */
        .view {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block;
            opacity: 1;
        }
        
        /* Improved modal styles with fade transition */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            /* Darker overlay for dark mode */
            background-color: rgba(0, 0, 0, 0.7); 
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* Error Toast (unchanged) */
        .error-toast {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 100;
            font-weight: 500;
            max-w-lg;
            text-align: center;
        }
        .error-toast.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<!-- NEW: Dark mode body with new text colors -->
<body class="bg-slate-900 text-slate-200 font-sans antialiased relative">

    <!-- NEW: Video Background with Overlay -->
    <!-- NEW: Added ID and transition classes -->
    <div id="video-background-wrapper" class="fixed inset-0 -z-30 transition-opacity duration-500">
        <video id="video-bg" class="absolute inset-0 w-full h-full object-cover" autoplay loop muted playsinline>
            <source src="vid.mp4" type="video/mp4">
            <!-- If this video file isn't found, the .onerror event in JS will fire -->
        </video>
        <div class="absolute inset-0 bg-black/50"></div> <!-- Translucent Overlay -->
    </div>

    <!-- NEW: CSS-only Animated Aurora Background (Now a fallback at z-20) -->
    <div class="fixed inset-0 -z-20 overflow-hidden">
        <div class="absolute left-[-20rem] top-[-10rem] w-[56.125rem] h-[56.125rem] bg-purple-500/30 rounded-full filter blur-[10rem]"></div>
        <div class="absolute right-[-15rem] bottom-[-10rem] w-[50rem] h-[50rem] bg-blue-500/30 rounded-full filter blur-[10rem]"></div>
    </div>

    <!-- =========== NEW: LANDING VIEW (Page 0) =========== -->
    <div id="landing-page" class="view active flex items-center justify-center min-h-screen p-4">
        <div class="text-center">
            <h1 class="text-5xl sm:text-7xl font-bold mb-4 inline-block bg-clip-text text-transparent bg-gradient-to-r from-white via-slate-200 to-slate-400">
                Generate Full Papers
            </h1>
            <h2 class="text-5xl sm:text-7xl font-bold mb-8 inline-block bg-clip-text text-transparent bg-gradient-to-r from-white via-slate-200 to-slate-400">
                Instantly.
            </h2>
            <p class="text-xl text-slate-300 max-w-2xl mx-auto mb-12">
                Welcome to Coopergen. The AI assistant for educators,Stop the busywork and start focusing on what truly matters. 
            </p>
            <button id="landing-cta-btn" class="text-xl font-semibold bg-white text-blue-700 rounded-full px-10 py-4 shadow-2xl hover:bg-slate-100 transition duration-300 transform hover:scale-105">
                Lessgoo
            </button>
        </div>
    </div>

    <!-- =========== LOGIN VIEW (Glassmorphism) =========== -->
    <div id="login-page" class="view flex items-center justify-center min-h-screen p-4"> <!-- Removed 'active' class -->
        <!-- NEW: Glassmorphism card -->
        <div class="relative bg-black/30 backdrop-blur-xl border border-white/10 p-10 sm:p-12 rounded-2xl shadow-2xl text-center w-full max-w-md">
            
            <!-- NEW: Back Button -->
            <button id="back-to-landing-btn" class="absolute top-4 left-4 text-slate-300 hover:text-white transition duration-200 p-2 rounded-full hover:bg-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            
            <h1 class="text-5xl font-bold text-white mb-2">Coopergen</h1>
            <p class="text-slate-300 mb-10 text-lg">AI Question Paper Generator</p>
            <!-- NEW: Glassmorphism button -->
            <button id="google-login-btn" class="flex items-center justify-center w-full px-6 py-4 bg-white/10 text-white font-semibold rounded-lg shadow-md border border-white/20 hover:bg-white/20 transition duration-300">
                <svg class="w-6 h-6 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.258 3.053-1.99 6.47-1.99 10.123c0 3.653.732 7.07 1.99 10.123l-5.657 5.657C.63 36.311 0 30.338 0 24c0-6.338.63-12.311 1.649-17.964l5.657 8.655z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657C30.01 35.08 27.208 36 24 36c-5.223 0-9.641-3.34-11.303-8H7.047v5.627C10.05 40.57 16.51 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l5.657 5.657C40.06 36.612 44 30.884 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- =========== APP VIEW (Glassmorphism) =========== -->
    <div id="app-page" class="view min-h-screen">
        <!-- NEW: Glassmorphism Header -->
        <header class="bg-black/30 backdrop-blur-lg sticky top-0 z-40 border-b border-white/10">
            <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-2xl font-bold text-white">Coopergen</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-greeting" class="text-slate-300"></span>
                        <!-- NEW: Profile Button -->
                        <button id="profile-btn" class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-semibold hover:bg-white/20 transition duration-300">
                            Profile
                        </button>
                        <!-- NEW: Glassmorphism button -->
                        <button id="logout-btn" class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-semibold hover:bg-white/20 transition duration-300">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- NEW: Glassmorphism Form Card -->
                <div class="bg-black/30 backdrop-blur-xl p-6 rounded-2xl shadow-lg border border-white/10">
                    <h2 class="text-2xl font-bold text-white mb-6">Create New Paper</h2>
                    <form id="paper-form" class="space-y-4">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Board -->
                            <div>
                                <label for="board" class="block text-sm font-medium text-slate-300">Board</label>
                                <!-- NEW: Glassmorphism Input -->
                                <input type="text" id="board" name="board" placeholder="e.g., CBSE, ICSE" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                            </div>
                            <!-- Class/Grade -->
                            <div>
                                <label for="class" class="block text-sm font-medium text-slate-300">Class/Grade</label>
                                <input type="text" id="class" name="class" placeholder="e.g., 10th, 12th" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Subject -->
                            <div>
                                <label for="subject" class="block text-sm font-medium text-slate-300">Subject</label>
                                <input type="text" id="subject" name="subject" placeholder="e.g., Physics, History" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                            </div>
                            <!-- Topic -->
                            <div>
                                <label for="topic" class="block text-sm font-medium text-slate-300">Topic</label>
                                <input type="text" id="topic" name="topic" placeholder="e.g., Electricity, Mughal Empire" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Difficulty -->
                            <div>
                                <label for="difficulty" class="block text-sm font-medium text-slate-300">Difficulty</label>
                                <!-- NEW: Glassmorphism Select -->
                                <select id="difficulty" name="difficulty" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                                    <option class="bg-slate-800">Easy</option>
                                    <option class="bg-slate-800" selected>Medium</option>
                                    <option class="bg-slate-800">Hard</option>
                                </select>
                            </div>
                            <!-- Language -->
                            <div>
                                <label for="language" class="block text-sm font-medium text-slate-300">Language</label>
                                <select id="language" name="language" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                                    <option class="bg-slate-800">English</option>
                                    <option class="bg-slate-800">Hindi</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Time -->
                            <div>
                                <label for="time" class="block text-sm font-medium text-slate-300">Time (minutes)</label>
                                <input type="number" id="time" name="time" value="60" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                            </div>
                            <!-- Total Marks -->
                            <div>
                                <label for="marks" class="block text-sm font-medium text-slate-300">Total Marks</label>
                                <input type="number" id="marks" name="marks" value="40" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                            </div>
                        </div>

                        <!-- Question Counts -->
                        <fieldset class="border border-white/20 p-4 rounded-md">
                            <legend class="text-sm font-medium text-slate-300 px-2">Question Counts</legend>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label for="mcq" class="block text-sm font-medium text-slate-300">MCQ</label>
                                    <input type="number" id="mcq" name="mcq" value="5" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                                </div>
                                <div>
                                    <label for="short" class="block text-sm font-medium text-slate-300">Short</label>
                                    <input type="number" id="short" name="short" value="5" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                                </div>
                                <div>
                                    <label for="long" class="block text-sm font-medium text-slate-300">Long</label>
                                    <input type="number" id="long" name="long" value="2" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                                </div>
                                <div>
                                    <label for="numerical" class="block text-sm font-medium text-slate-300">Numerical</label>
                                    <input type="number" id="numerical" name="numerical" value="0" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm">
                                </div>
                            </div>
                        </fieldset>

                        <!-- Extra Instructions -->
                        <div>
                            <label for="instructions" class="block text-sm font-medium text-slate-300">Extra Instructions</label>
                            <textarea id="instructions" name="instructions" rows="3" class="mt-1 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm" placeholder="e.g., All questions are compulsory. Focus on derivations."></textarea>
                        </div>

                        <!-- Generate Button (Solid for contrast) -->
                        <div>
                            <button id="generate-btn" type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                <span id="generate-btn-text">Generate Paper</span>
                                <svg id="generate-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- NEW: Glassmorphism Preview Card -->
                <div class="bg-black/30 backdrop-blur-xl p-6 rounded-2xl shadow-lg border border-white/10">
                    <!-- NEW: Layout wrapper for header -->
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                        <h2 class="text-2xl font-bold text-white mb-4 sm:mb-0">Live Preview</h2>
                        
                        <!-- NEW: Group for Toggle and Buttons -->
                        <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                            <!-- NEW: Include Answers Toggle -->
                            <div class="flex items-center space-x-2 justify-end mb-2 sm:mb-0">
                                <label for="include-answers-toggle" class="text-sm font-medium text-slate-300">Include Answers</label>
                                <button type="button" id="include-answers-toggle" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-600 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" role="switch" aria-checked="false">
                                    <span class="sr-only">Include Answers</span>
                                    <span id="include-answers-knob" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow-lg ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                                </button>
                            </div>
                            
                            <!-- Existing Buttons -->
                            <div class="flex space-x-2 justify-end">
                                <button id="download-json-btn" class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-semibold hover:bg-white/20 transition duration-300 disabled:opacity-50" disabled>Download JSON</button>
                                <button id="download-pdf-btn" class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-semibold hover:bg-white/20 transition duration-300 disabled:opacity-50" disabled>Download PDF</button>
                            </div>
                        </div>
                    </div>
                    <!-- NEW: Darker preview area -->
                    <pre id="preview-area" class="w-full h-96 bg-black/50 text-slate-200 p-4 rounded-md overflow-auto text-sm whitespace-pre-wrap break-words">Click "Generate Paper" to see the AI output here...</pre>
                </div>
            </div>
        </main>
    </div>

    <!-- =========== NAME MODAL (Glassmorphism) =========== -->
    <div id="name-modal" class="modal-overlay">
        <!-- NEW: Glassmorphism card -->
        <div class="bg-black/40 backdrop-blur-xl border border-white/10 p-10 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4">Welcome to Coopergen!</h2>
            <p class="text-slate-300 mb-6">Since this is your first time, please tell us your name so we can set up your account.</p>
            <form id="name-form">
                <label for="name" class="block text-sm font-medium text-slate-300">Full Name</label>
                <!-- NEW: Glassmorphism Input -->
                <input type="text" id="name" name="name" class="mt-1 mb-6 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm" required>
                <!-- Button is solid for contrast -->
                <button type="submit" class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    Save and Continue
                </button>
            </form>
        </div>
    </div>

    <!-- =========== NEW: PROFILE MODAL (Glassmorphism) =========== -->
    <div id="profile-page" class="modal-overlay">
        <!-- NEW: Glassmorphism card -->
        <div class="relative bg-black/40 backdrop-blur-xl border border-white/10 p-10 rounded-2xl shadow-2xl w-full max-w-md">
            
            <!-- Close Button -->
            <button id="close-profile-btn" class="absolute top-4 right-4 text-slate-300 hover:text-white transition duration-200 p-2 rounded-full hover:bg-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-bold text-white mb-4">Your Profile</h2>
            <p class="text-slate-300 mb-6">Update your personal information. Your email is linked to your Google Account.</p>
            <form id="profile-form">
                <div>
                    <label for="profile-name" class="block text-sm font-medium text-slate-300">Full Name</label>
                    <input type="text" id="profile-name" name="profile-name" class="mt-1 mb-4 block w-full rounded-md bg-black/20 border-white/20 text-white placeholder:text-slate-400 shadow-sm focus:border-blue-400 focus:ring-blue-400 sm:text-sm" required>
                </div>
                <div>
                    <label for="profile-email" class="block text-sm font-medium text-slate-300">Email (read-only)</label>
                    <input type="email" id="profile-email" name="profile-email" class="mt-1 mb-6 block w-full rounded-md bg-black/50 border-white/10 text-slate-400 shadow-sm sm:text-sm" readonly>
                </div>
                <button id="update-profile-btn" type="submit" class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- =========== Error Toast (Unchanged) =========== -->
    <div id="error-toast" class="error-toast">
        <span id="error-message"></span>
    </div>

    <!-- =========== JAVASCRIPT (Unchanged) =========== -->
    <script type="module">
        // 3. Import Firebase functions from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 4. Your web app's Firebase configuration (as provided)
        const firebaseConfig = {
          apiKey: "AIzaSyDCkWwVm0LuqxfHczruse9gh8pGGyI4nvg",
          authDomain: "coopergen-5332f.firebaseapp.com",
          projectId: "coopergen-5332f",
          storageBucket: "coopergen-5332f.firebasestorage.app",
          messagingSenderId: "432850916875",
          appId: "1:432850916875:web:c5dc6709400082cab3190e"
        };

        // 5. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- State ---
        let currentUser = null;
        let currentUserData = null; // NEW: To store Firestore user data
        let generatedPaper = null; // Store the JSON response

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const appPage = document.getElementById('app-page');
        const nameModal = document.getElementById('name-modal');
        const landingPage = document.getElementById('landing-page'); // NEW
        
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');
        const landingCtaBtn = document.getElementById('landing-cta-btn'); // NEW
        const backToLandingBtn = document.getElementById('back-to-landing-btn'); // NEW
        
        // NEW: Profile Page Elements
        const profilePage = document.getElementById('profile-page');
        const profileBtn = document.getElementById('profile-btn');
        const closeProfileBtn = document.getElementById('close-profile-btn');
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileEmailInput = document.getElementById('profile-email');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name');
        
        const paperForm = document.getElementById('paper-form');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateSpinner = document.getElementById('generate-spinner');
        
        const previewArea = document.getElementById('preview-area');
        const downloadJsonBtn = document.getElementById('download-json-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const videoBg = document.getElementById('video-bg'); // NEW
        const videoBackgroundWrapper = document.getElementById('video-background-wrapper'); // NEW
        const includeAnswersToggle = document.getElementById('include-answers-toggle'); // NEW
        const includeAnswersKnob = document.getElementById('include-answers-knob'); // NEW

        // NEW: Error Toast Elements
        const errorToast = document.getElementById('error-toast');
        const errorMessage = document.getElementById('error-message');

        // --- View Controller ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');

            // NEW: Video Background Control
            if (viewId === 'app-page') {
                videoBackgroundWrapper.style.opacity = '0';
                videoBg.pause();
            } else {
                videoBackgroundWrapper.style.opacity = '1';
                videoBg.play().catch(e => { /* Autoplay was fine */ });
            }
        }

        // NEW: Error Handling Function
        function showError(message) {
            errorMessage.textContent = message;
            errorToast.classList.add('active');
            // Hide the toast after 5 seconds
            setTimeout(() => {
                errorToast.classList.remove('active');
            }, 5000);
        }

        // --- Auth Logic (UPDATED with try...catch) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // User is signed in
                    currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        // User exists, show app
                        const userData = userDoc.data();
                        currentUserData = userData; // NEW: Store user data
                        userGreeting.textContent = `Hi, ${userData.name.split(' ')[0]}!`;
                        showView('app-page');
                    } else {
                        // New user, ask for name
                        nameInput.value = user.displayName || '';
                        showView('name-modal');
                    }
                } catch (error) {
                    // This is where the ad blocker error gets caught!
                    console.error("Firestore Error on auth change:", error);
                    if (error.code === 'unavailable' || (error.message && error.message.includes('ERR_BLOCKED_BY_CLIENT'))) {
                        showError("Connection to database failed. Please disable your ad blocker for this site and refresh.");
                    } else {
                        showError(`Error checking user data: ${error.message}`);
                    }
                    // Log them out to prevent a broken state
                    await signOut(auth);
                }
            } else {
                // User is signed out
                currentUser = null;
                showView('landing-page'); // UPDATED (was 'login-page')
            }
        });

        // Google Login (UPDATED with .catch)
        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    // This will catch "auth/unauthorized-domain" errors
                    showError(`Google Sign-In Error: ${error.message}`);
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            // onAuthStateChanged will handle showing the landing page
        });

        // NEW: Profile Page Logic
        profileBtn.addEventListener('click', () => {
            if (!currentUserData) return; // Safety check
            // Pre-fill the form
            profileNameInput.value = currentUserData.name;
            profileEmailInput.value = currentUserData.email || 'N/A'; // Email might not exist on old accounts
            // Show the modal
            profilePage.classList.add('active');
        });

        closeProfileBtn.addEventListener('click', () => {
            // Just hide the modal, don't change the main view
            profilePage.classList.remove('active');
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = profileNameInput.value.trim();
            if (!newName || !currentUser) {
                showError("Name cannot be empty.");
                return;
            }

            // Disable button
            updateProfileBtn.disabled = true;
            updateProfileBtn.textContent = 'Saving...';
            
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                // Use updateDoc to only change the name field
                await updateDoc(userDocRef, {
                    name: newName
                });

                // Update local state
                currentUserData.name = newName;
                userGreeting.textContent = `Hi, ${newName.split(' ')[0]}!`;
                
                // Close modal
                profilePage.classList.remove('active');

            } catch (error) {
                console.error("Error updating name:", error);
                showError(`Failed to update name: ${error.message}`);
            } finally {
                // Re-enable button
                updateProfileBtn.disabled = false;
                updateProfileBtn.textContent = 'Save Changes';
            }
        });

        // NEW: Landing Page Buttons
        landingCtaBtn.addEventListener('click', () => {
            showView('login-page');
        });

        backToLandingBtn.addEventListener('click', () => {
            showView('landing-page');
        });

        // NEW: Video Background Fallback
        // If vid.mp4 fails to load (404, etc.), hide the video element
        // This will let the CSS aurora background show through.
        videoBg.onerror = () => {
            console.log("Video background failed to load. Displaying fallback.");
            videoBg.style.display = 'none';
        };

        // NEW: Toggle Switch Logic
        includeAnswersToggle.addEventListener('click', () => {
            const isChecked = includeAnswersToggle.getAttribute('aria-checked') === 'true';
            includeAnswersToggle.setAttribute('aria-checked', !isChecked);
            if (!isChecked) {
                includeAnswersToggle.classList.replace('bg-gray-600', 'bg-blue-600');
                includeAnswersKnob.classList.replace('translate-x-0', 'translate-x-5');
            } else {
                includeAnswersToggle.classList.replace('bg-blue-600', 'bg-gray-600');
                includeAnswersKnob.classList.replace('translate-x-5', 'translate-x-0');
            }
        });

        // New User Name Submit (UPDATED with try...catch)
        nameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            if (name && currentUser) {
                try {
                    // This saves the name to the database as requested
                    const userData = { // NEW
                        name: name,
                        email: currentUser.email,
                        uid: currentUser.uid
                    };
                    await setDoc(doc(db, "users", currentUser.uid), userData);
                    currentUserData = userData; // NEW: Set local data
                    userGreeting.textContent = `Hi, ${name.split(' ')[0]}!`;
                    showView('app-page');
                } catch (error) {
                    console.error("Error saving name:", error);
                    showError(`Failed to save name: ${error.message}. Please check your connection.`);
                }
            }
        });
        
        // --- App Logic (Form Submission) ---
        paperForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. Show loading state
            setLoading(true);
            previewArea.textContent = "Generating your paper... This may take a moment.";
            generatedPaper = null;
            // Disable download buttons
            downloadJsonBtn.disabled = true;
            downloadPdfBtn.disabled = true;

            // 2. Collect form data into a 'blueprint' object
            const formData = new FormData(paperForm);
            const blueprint = {};
            for (let [key, value] of formData.entries()) {
                // Convert numbers
                if (['time', 'marks', 'mcq', 'short', 'long', 'numerical'].includes(key)) {
                    value = Number(value);
                }
                blueprint[key] = value;
            }

            // 3. Call the secure backend API
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ blueprint }) // Send the blueprint nested
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // 4. Handle response
                generatedPaper = data.paper; // Assuming the backend returns { paper: {...} }
                previewArea.textContent = JSON.stringify(generatedPaper, null, 2);
                downloadJsonBtn.disabled = false;
                downloadPdfBtn.disabled = false;

            } catch (error) {
                console.error('Error calling /api/generate:', error);
                // Also use our new error handler here
                showError(error.message);
                previewArea.textContent = `Error: ${error.message}\n\nDid you create the api/generate.js file and add your API key to Vercel?`;
            } finally {
                // 5. Hide loading state
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtnText.classList.add('hidden');
                generateSpinner.classList.remove('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtnText.classList.remove('hidden');
                generateSpinner.classList.add('hidden');
            }
        }
        
        // --- Download Logic ---
        
        // Download JSON
        downloadJsonBtn.addEventListener('click', () => {
            if (!generatedPaper) return;
            
            const jsonString = JSON.stringify(generatedPaper, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'coopergen-paper.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Download PDF
        downloadPdfBtn.addEventListener('click', () => {
            if (!generatedPaper) return;

            // NEW: Check toggle state
            const includeAnswers = includeAnswersToggle.getAttribute('aria-checked') === 'true';

            // Use the jsPDF library loaded from the CDN
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("Question Paper", 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            
            // Add metadata
            const meta = generatedPaper.metadata;
            if(meta) {
                doc.text(`Board: ${meta.board || 'N/A'}`, 20, 35);
                doc.text(`Class: ${meta.class || 'N/A'}`, 20, 42);
                doc.text(`Subject: ${meta.subject || 'N/A'}`, 20, 49);
                doc.text(`Time: ${meta.time || 'N/A'} mins`, 150, 35);
                doc.text(`Marks: ${meta.totalMarks || 'N/A'}`, 150, 42);
            }
            
            let yPos = 65; // Starting Y position for questions

            // Simple function to add text with word wrap
            const addWrappedText = (text, y) => {
                const lines = doc.splitTextToSize(text, 170); // 170mm width
                doc.text(lines, 20, y);
                return y + (lines.length * 7); // Increment Y pos
            };
            
            // Loop through sections and questions
            if (generatedPaper.sections) {
                generatedPaper.sections.forEach(section => {
                    if (yPos > 270) { doc.addPage(); yPos = 20; } // Add new page
                    doc.setFont("helvetica", "bold");
                    yPos = addWrappedText(`Section: ${section.title} (${section.marks} Marks)`, yPos);
                    yPos += 2; // Extra space

                    section.questions.forEach(q => {
                        if (yPos > 270) { doc.addPage(); yPos = 20; } // Add new page
                        doc.setFont("helvetica", "normal");
                        const qText = `${q.q_num}. ${q.question} (${q.marks} marks)`;
                        yPos = addWrappedText(qText, yPos);

                        // NEW: Add options for MCQs
                        if (q.options && Array.isArray(q.options)) {
                            yPos += 2; // small space
                            q.options.forEach(opt => {
                                yPos = addWrappedText(`  - ${opt}`, yPos);
                            });
                        }
                        
                        // NEW: Add answer (for review)
                        // UPDATED: Check toggle state
                        if (includeAnswers && q.answer) {
                            yPos += 1;
                            doc.setFont("helvetica", "italic");
                            yPos = addWrappedText(`  Answer: ${q.answer}`, yPos);
                            doc.setFont("helvetica", "normal");
                        }

                        yPos += 4; // Space after question
                    });
                    yPos += 6; // Space after section
                });
            }

            doc.save('coopergen-paper.pdf');
        });

    </script>
</body>
</html>
